<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Code Editor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/codemirror.min.css">
  <style>
    body { margin:0; background:#1e1e1e; color:#d4d4d4; font-family:monospace; height:100vh; display:flex; flex-direction:column; }
    #entry { margin:auto; text-align:center; }
    input,button { padding:8px; margin:5px; font-size:16px; }
    #statusBar { padding:6px; background:#333; font-size:14px; text-align:center; }
    #editor { flex:1; height:80vh; }
    #bottom { display:flex; padding:8px; background:#252526; }
    #msg { flex:1; background:#1e1e1e; color:#d4d4d4; border:1px solid #333; padding:6px; font-family:monospace; }
    #send,#ping { margin-left:8px; padding:6px 12px; background:#0e639c; color:white; border:none; cursor:pointer; }
    #overlay { position:fixed; top:0;left:0;right:0;bottom:0; background:rgba(30,30,30,0.95); color:white;
               display:none; justify-content:center; align-items:center; font-size:24px; z-index:10; }
  </style>
</head>
<body>
  <div id="entry">
    <h2 style="color:white;">Enter Secret Phrase</h2>
    <input id="secret" placeholder="Secret phrase"/>
    <button onclick="joinRoom()">Open</button>
    <p style="color:gray;font-size:14px;">Both people must enter the exact same phrase.</p>
  </div>

  <div id="chat" style="display:none; flex:1; flex-direction:column;">
    <div id="statusBar">üî¥ Not connected</div>
    <div id="editor"></div>
    <div id="bottom">
      <input id="msg" placeholder="Type here..." />
      <button id="send">Send</button>
      <button id="ping">Ping</button>
    </div>
  </div>

  <div id="overlay">‚è≥ Session Ended</div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/mode/javascript/javascript.min.js"></script>
  <script src="https://unpkg.com/simple-peer@9.11.1/simplepeer.min.js"></script>
  <script>
    let editor, peer, conn, sessionTimer;
    let isInitiator = false;

    function setStatus(text, color) {
      const bar = document.getElementById("statusBar");
      bar.innerText = text;
      bar.style.color = color;
    }

    function joinRoom() {
      const room = document.getElementById('secret').value.trim();
      if (!room) return;

      document.getElementById('entry').style.display = 'none';
      document.getElementById('chat').style.display = 'flex';

      // Initialize CodeMirror
      editor = CodeMirror(document.getElementById('editor'), {
        lineNumbers: true,
        mode: "javascript",
        theme: "default",
        readOnly: true
      });

      // One side will be initiator (decided randomly)
      isInitiator = Math.random() > 0.5;

      peer = new SimplePeer({ initiator: isInitiator, trickle:false });

      peer.on('signal', data => {
        // Encode signal into URL hash
        const signalStr = btoa(JSON.stringify(data));
        location.hash = room + ":" + signalStr;
      });

      window.addEventListener("hashchange", () => {
        const hash = location.hash.substring(1);
        if (!hash.startsWith(room)) return;
        const theirSignal = hash.split(":")[1];
        try {
          peer.signal(JSON.parse(atob(theirSignal)));
        } catch(e){}
      });

      peer.on('connect', () => {
        setStatus("üü¢ Connected", "lightgreen");
        editor.setValue("// Connected. Session live for 2 hrs.\n");
        sessionTimer = setTimeout(() => endSession(), 2*60*60*1000);
      });

      peer.on('data', data => {
        const msg = JSON.parse(data.toString());
        if (msg.type==="msg") {
          addLine("console.log(\"" + msg.text + "\");");
          setTimeout(() => editor.setValue(editor.getValue().replace("console.log(\"" + msg.text + "\");\n","")), 600000);
        }
        if (msg.type==="ping") {
          addLine("// Someone is here üëÄ");
          setTimeout(() => editor.setValue(editor.getValue().replace("// Someone is here üëÄ\n","")), 600000);
        }
      });

      peer.on('close', () => setStatus("üî¥ Disconnected", "red"));
      peer.on('error', () => setStatus("‚ö†Ô∏è Error", "orange"));

      document.getElementById('send').onclick = sendMessage;
      document.getElementById('ping').onclick = () => {
        peer.send(JSON.stringify({type:"ping"}));
        addLine("// You pinged them");
        setTimeout(() => editor.setValue(editor.getValue().replace("// You pinged them\n","")), 600000);
      };
      document.getElementById('msg').addEventListener("keypress", e=>{
        if (e.key==="Enter") { e.preventDefault(); sendMessage(); }
      });
    }

    function sendMessage() {
      const text = document.getElementById('msg').value.trim();
      if (!text) return;
      peer.send(JSON.stringify({type:"msg", text}));
      addLine("console.log(\"" + text + "\");");
      setTimeout(() => editor.setValue(editor.getValue().replace("console.log(\"" + text + "\");\n","")), 600000);
      document.getElementById('msg').value = "";
    }

    function addLine(line) {
      editor.setValue(editor.getValue() + line + "\n");
    }

    function endSession() {
      document.getElementById('chat').style.display = 'none';
      document.getElementById('overlay').style.display = 'flex';
      if (peer) peer.destroy();
    }
  </script>
</body>
</html>
