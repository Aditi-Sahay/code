<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Editor</title>
  <style>
    body {
      background: #1e1e1e;
      color: #d4d4d4;
      font-family: monospace;
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    #editor {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    #input {
      border: none;
      outline: none;
      padding: 10px;
      font-family: monospace;
      font-size: 14px;
      width: 100%;
      background: #1e1e1e;
      color: #d4d4d4;
    }
    #status {
      font-size: 12px;
      padding: 5px;
      background: #333;
      color: #ccc;
    }
  </style>
</head>
<body>
  <div id="status">ðŸ”´ Not Connected</div>
  <div id="editor"></div>
  <input id="input" placeholder="Type and press Enter...">
  
  <script src="https://unpkg.com/simple-peer@9.11.1/simplepeer.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/uuid@9.0.0/dist/umd/uuidv4.min.js"></script>
  <script>
    const statusEl = document.getElementById('status');
    const editor = document.getElementById('editor');
    const input = document.getElementById('input');

    // Ask for secret phrase
    let room = prompt("Enter secret phrase:");
    if (!room) room = "default-room";

    // Connect to signaling server
    const ws = new WebSocket("wss://signaling.openrelay.metered.ca");
    let peer;
    const id = uuidv4();

    ws.onopen = () => {
      ws.send(JSON.stringify({ type: "join", room, id }));
    };

    ws.onmessage = async (event) => {
      const msg = JSON.parse(event.data);

      if (msg.type === "ready" && msg.ids && msg.ids.length > 1) {
        // Decide initiator
        const initiator = id === msg.ids.sort()[0];
        if (!peer) makePeer(initiator);
      }

      if (msg.type === "signal" && msg.from !== id && peer) {
        peer.signal(msg.data);
      }
    };

    function makePeer(initiator) {
      peer = new SimplePeer({
        initiator,
        trickle: false,
        config: {
          iceServers: [
            { urls: "stun:stun.l.google.com:19302" },
            { urls: "turn:openrelay.metered.ca:443", username: "openrelayproject", credential: "openrelayproject" }
          ]
        }
      });

      peer.on("signal", data => {
        ws.send(JSON.stringify({ type: "signal", room, from: id, data }));
      });

      peer.on("connect", () => {
        statusEl.textContent = "ðŸŸ¢ Connected";
      });

      peer.on("data", data => {
        addLine("them", data.toString());
      });
    }

    function addLine(sender, text) {
      const line = sender === "me" ? 
        `console.log("${text}");` : 
        `> ${text}`;
      editor.innerHTML += line + "\n";
      editor.scrollTop = editor.scrollHeight;
    }

    // Send on Enter
    input.addEventListener("keydown", e => {
      if (e.key === "Enter" && input.value.trim()) {
        const msg = input.value.trim();
        addLine("me", msg);
        if (peer) peer.send(msg);
        input.value = "";
      }
    });

    // Auto-delete after 10 mins
    setInterval(() => editor.innerHTML = "", 10 * 60 * 1000);

    // Auto-close after 2 hrs
    setTimeout(() => window.close(), 2 * 60 * 60 * 1000);
  </script>
</body>
</html>
